# =============================================================================
# Vault Apply - Declarative Configuration File
# =============================================================================
#
# Usage:
#   stackctl vault apply -f vault-config.yaml
#   stackctl vault apply -f vault-config.yaml --vault-addr http://vault.local:8200
#   stackctl vault apply -f vault-config.yaml --vault-token hvs.xxxxx
#
# Execution order: engines -> auth -> policies -> roles -> secrets
# Each section is optional. Include only what you need.
#
# Authentication (in priority order):
#   1. Flags: --vault-addr, --vault-token, --vault-role-id, --vault-secret-id
#   2. Env vars: VAULT_ADDR, VAULT_TOKEN, VAULT_ROLE_ID, VAULT_SECRET_ID
#   3. Fallback: $HOME/.vault-token (created by 'vault login')
# =============================================================================

# =============================================================================
# SECRETS ENGINES
# =============================================================================
# Manage Vault secrets engines (mounts).
# Equivalent to: vault secrets enable / vault secrets disable
#
# Common types: kv (v1/v2), transit, pki, database, aws, ssh
# For KV, use type: kv-v2 (auto-configures version: 2)
engines:
  # Enable new engines
  enable:
    # KV v2 - Default engine for key/value secret storage
    - type: kv-v2
      path: secret                        # mount path (default: same as type)
      description: "KV v2 secrets engine for general storage"
      # version: "2"                      # optional, default "2" for kv-v2

    # Transit - Encryption as a service
    # - type: transit
    #   path: transit
    #   description: "Transit engine for encrypt/decrypt"

    # PKI - Engine for TLS certificates
    # - type: pki
    #   path: pki
    #   description: "PKI engine for internal certificates"

  # Disable engines (WARNING: removes all data in the mount!)
  disable: []
    # - old-secret-engine
    # - transit-deprecated

# =============================================================================
# AUTH METHODS
# =============================================================================
# Manage Vault authentication methods.
# Equivalent to: vault auth enable / vault auth disable
#
# Common types: kubernetes, approle, userpass, ldap, oidc, token
auth:
  # Enable new auth methods
  enable:
    # Kubernetes auth - for pods to authenticate via ServiceAccount
    - type: kubernetes
      path: k8s-vps-01-oracle             # mount path (default: same as type)
      description: "Kubernetes auth for Oracle VPS cluster"

    # AppRole auth - for CI/CD and automation
    - type: approle
      path: approle                        # mount path
      description: "AppRole auth for CI/CD pipelines"

    # Userpass - for human users (dev/staging)
    # - type: userpass
    #   path: userpass
    #   description: "Userpass auth for dev environment"

  # Disable auth methods
  disable: []
    # - old-kubernetes-auth
    # - userpass-deprecated

# =============================================================================
# POLICIES
# =============================================================================
# Manage Vault policies (HCL or inline).
# Equivalent to: vault policy write / vault policy delete
#
# Each policy can be defined in two ways:
#   1. file: path to an .hcl file
#   2. rules: inline HCL rules (multiline string)
policies:
  # Create/Update policies
  add:
    # Policy for reading kubeconfig via CI
    - name: ci-kubeconfig-read
      rules: |
        # Allow reading kubeconfig secrets
        path "secret/data/resources/kubeconfig/*" {
          capabilities = ["read", "list"]
        }
        # Allow listing metadata
        path "secret/metadata/resources/kubeconfig/*" {
          capabilities = ["read", "list"]
        }

    # Policy for full secret management of a project
    - name: project-oracle-admin
      rules: |
        # Full CRUD on project path
        path "secret/data/resources/kubeconfig/oracle-elias" {
          capabilities = ["create", "read", "update", "delete"]
        }
        path "secret/metadata/resources/kubeconfig/oracle-elias" {
          capabilities = ["read", "list", "delete"]
        }

    # Policy from external HCL file
    # - name: custom-policy
    #   file: policies/custom-policy.hcl

  # Update existing policies (same syntax as add)
  update:
    - name: ci-kubeconfig-read
      rules: |
        path "secret/data/resources/kubeconfig/*" {
          capabilities = ["read", "list"]
        }
        path "secret/metadata/resources/kubeconfig/*" {
          capabilities = ["read", "list"]
        }
        # Added: allow reading app configs too
        path "secret/data/apps/*" {
          capabilities = ["read"]
        }

  # Delete policies
  delete: []
    # - old-policy-name
    # - deprecated-ci-policy

# =============================================================================
# ROLES
# =============================================================================
# Manage roles within auth methods.
# Equivalent to: vault write auth/<mount>/role/<name>
#
# Available fields:
#   auth_mount:                       auth method mount path (e.g., auth/kubernetes)
#   name:                             role name
#   action:                           add | update | delete (default: add)
#
# For Kubernetes auth:
#   bound_service_account_names:      ServiceAccount names (comma-separated)
#   bound_service_account_namespaces: Allowed namespaces (comma-separated)
#   policies:                         Policies to attach (comma-separated)
#   ttl:                              Token TTL (e.g., 1h, 24h)
#
# For AppRole auth:
#   token_policies:                   Token policies (comma-separated)
#   ttl:                              Token TTL
#   token_max_ttl:                    Max Token TTL
#   token_type:                       Token type (default, batch, service)
#   secret_id_ttl:                    Secret ID TTL (0 = no expiry)
#   secret_id_num_uses:               Secret ID num uses (0 = unlimited)
roles:
  # Kubernetes Role - allows pods in 'ci' namespace to authenticate
  - auth_mount: auth/k8s-vps-01-oracle
    name: ci-kubeconfig
    action: add                            # add | update | delete
    bound_service_account_names: "github-runner,ci-runner"
    bound_service_account_namespaces: "ci,github-actions"
    policies: "ci-kubeconfig-read"
    ttl: "1h"

  # AppRole Role - for CI/CD pipeline
  - auth_mount: auth/approle
    name: ci-kubeconfig
    action: add
    token_policies: "ci-kubeconfig-read"
    ttl: "1h"
    token_max_ttl: "4h"
    token_type: "service"
    secret_id_ttl: "0"                     # 0 = no expiry
    secret_id_num_uses: 0                  # 0 = unlimited

  # Delete a role
  # - auth_mount: auth/kubernetes
  #   name: old-role
  #   action: delete

# =============================================================================
# SECRETS
# =============================================================================
# Manage Vault KV v2 secrets.
# Equivalent to: vault kv put / vault kv patch / vault kv delete
#
# Entry fields:
#   name:           key name inside the secret
#   value:          fixed value (string)
#   auto_generate:  true to generate random value (hex)
#   size:           size in bytes of generated value (default: 20 = 40 hex chars)
#                   equivalent to: openssl rand -hex <size>
#
# The path must use the 'secret/data/' prefix for KV v2.
secrets:
  path: secret/data/resources/kubeconfig/oracle-elias

  # Add new keys (merge with existing)
  add:
    # Fixed value - e.g., base64 encoded kubeconfig
    - name: KUBECONFIG
      value: "kubeconfig-base64-encoded-content-here"

    # Auto-generated value - generates 25 bytes = 50 hex chars
    - name: DATABASE_PASSWORD
      auto_generate: true
      size: 25

    # Auto-generated value with smaller size
    - name: DATABASE_USER
      auto_generate: true
      size: 15

    # Auto-generated value with default size (20 bytes = 40 hex chars)
    # - name: API_KEY
    #   auto_generate: true

  # Update existing keys (reads current secret and merges)
  update:
    - name: KUBECONFIG
      value: "kubeconfig-v2-base64-encoded"

    - name: DATABASE_PASSWORD
      auto_generate: true
      size: 25

    - name: DATABASE_USER
      auto_generate: true
      size: 20

  # Delete individual keys from the secret (removes key, not entire secret)
  delete:
    - name: OLD_API_KEY
    - name: DEPRECATED_TOKEN
    # To delete the entire secret, use the CLI:
    #   stackctl vault secret delete secret/metadata/resources/kubeconfig/oracle-elias
